# API для работы с сотрудниками HealApp

## Оглавление

1. [Обзор системы сотрудников](#обзор-системы-сотрудников)
2. [Роли сотрудников](#роли-сотрудников)
3. [Приглашение сотрудников](#приглашение-сотрудников)
4. [Управление сотрудниками](#управление-сотрудниками)
5. [Назначение доступа к дневникам](#назначение-доступа-к-дневникам)
6. [API Endpoints](#api-endpoints)
7. [Примеры использования](#примеры-использования)
8. [Рабочие сценарии](#рабочие-сценарии)

---

## Обзор системы сотрудников

Сотрудники в HealApp — это пользователи, привязанные к организации (`Organization`). Они имеют определённые роли и права доступа.

### Ключевые понятия

| Понятие | Описание |
|---------|----------|
| **Организация** | Пансионат или патронажное агентство |
| **Владелец (Owner)** | Создатель организации, полные права |
| **Сотрудник** | Пользователь с `organization_id` и ролью |
| **Приглашение** | Ссылка для добавления сотрудника |

### Структура таблиц

```
┌─────────────────────────────────────────────────────────────────┐
│                         organizations                            │
├─────────────────────────────────────────────────────────────────┤
│ id │ owner_id │ name │ type (agency/boarding_house) │ phone │...│
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ hasMany
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                            users                                 │
├─────────────────────────────────────────────────────────────────┤
│ id │ organization_id │ first_name │ last_name │ phone │ type │..│
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ hasRoles (Spatie)
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      model_has_roles                             │
├─────────────────────────────────────────────────────────────────┤
│ role_id │ model_type │ model_id                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Роли сотрудников

### Иерархия ролей

```
                    ┌──────────┐
                    │  OWNER   │  ◀── Создатель организации
                    │ (Полные  │      Нельзя удалить/изменить роль
                    │  права)  │
                    └────┬─────┘
                         │
                         ▼
                    ┌──────────┐
                    │  ADMIN   │  ◀── Администратор
                    │ (Почти   │      Может управлять сотрудниками
                    │  все)    │      Не может удалить Owner/Admin
                    └────┬─────┘
                         │
              ┌──────────┴──────────┐
              ▼                     ▼
        ┌──────────┐          ┌───────────┐
        │  DOCTOR  │          │ CAREGIVER │
        │ (Врач)   │          │ (Сиделка) │
        │          │          │           │
        └──────────┘          └───────────┘
```

### Сравнение ролей

| Возможность | Owner | Admin | Doctor | Caregiver |
|-------------|:-----:|:-----:|:------:|:---------:|
| Изменение организации | ✅ | ✅ | ❌ | ❌ |
| Приглашение сотрудников | ✅ | ✅ | ❌ | ❌ |
| Удаление сотрудников | ✅ | ✅* | ❌ | ❌ |
| Изменение ролей | ✅ | ❌ | ❌ | ❌ |
| Создание пациентов | ✅ | ✅ | ❌ | ❌ |
| Просмотр пациентов | ✅ | ✅ | ✅ | ✅ |
| Создание задач | ✅ | ✅ | ✅ | ❌ |
| Выполнение задач | ✅ | ✅ | ❌ | ✅ |
| Управление доступом | ✅ | ✅ | ❌ | ❌ |

> *Admin может удалять только Doctor и Caregiver, не других Admin

---

## Приглашение сотрудников

### Процесс приглашения

```
┌──────────────────────────────────────────────────────────────────┐
│                       1. СОЗДАНИЕ ПРИГЛАШЕНИЯ                     │
└──────────────────────────────────────────────────────────────────┘
                              │
        Owner/Admin отправляет запрос
        POST /api/v1/invitations/employee
        {"role": "doctor"}
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                       2. ГЕНЕРАЦИЯ ТОКЕНА                         │
│                                                                   │
│  • Создаётся запись в таблице invitations                        │
│  • Генерируется 64-символьный токен                              │
│  • Срок действия: 7 дней                                         │
│  • Статус: pending                                               │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                       3. ОТПРАВКА ССЫЛКИ                          │
│                                                                   │
│  Response:                                                        │
│  {                                                                │
│    "invitation": {...},                                           │
│    "invite_url": "https://app.com/invite/abc123..."               │
│  }                                                                │
│                                                                   │
│  ⚠️ Ссылку нужно передать сотруднику вручную/через мессенджер    │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    4. ПЕРЕХОД ПО ССЫЛКЕ                           │
│                                                                   │
│  Сотрудник открывает ссылку во Flutter-приложении                │
│  или в браузере                                                   │
│  GET /api/v1/invitations/{token}                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    5. ИНФОРМАЦИЯ О ПРИГЛАШЕНИИ                    │
│                                                                   │
│  Response:                                                        │
│  {                                                                │
│    "organization_name": "Пансионат 'Забота'",                     │
│    "organization_type": "boarding_house",                         │
│    "type": "employee",                                            │
│    "role": "doctor",                                              │
│    "expires_at": "2025-12-29T14:37:00+05:00"                      │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
                              │
        Сотрудник уже зарегистрирован?
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
        ┌─────────┐                     ┌─────────┐
        │   Да    │                     │   Нет   │
        └────┬────┘                     └────┬────┘
             │                               │
             ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│ 6a. АВТОРИЗАЦИЯ         │     │ 6b. РЕГИСТРАЦИЯ         │
│                         │     │                         │
│ POST /invitations/      │     │ POST /invitations/      │
│   {token}/accept        │     │   {token}/accept        │
│ {                       │     │ {                       │
│   "phone": "79...",     │     │   "phone": "79...",     │
│   "password": "***"     │     │   "password": "***",    │
│ }                       │     │   "password_confirm...  │
│                         │     │   "first_name": "...",  │
│                         │     │   "last_name": "..."    │
│                         │     │ }                       │
└────────────┬────────────┘     └────────────┬────────────┘
             │                               │
             └───────────────┬───────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│                    7. ПРИВЯЗКА К ОРГАНИЗАЦИИ                      │
│                                                                   │
│  • user.organization_id = invitation.organization_id             │
│  • user.syncRoles([invitation.role])                             │
│  • invitation.status = 'accepted'                                 │
│  • Автоматическая верификация телефона                           │
│  • Создание access_token                                          │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    8. СОТРУДНИК В СИСТЕМЕ                         │
│                                                                   │
│  Response:                                                        │
│  {                                                                │
│    "message": "Приглашение принято",                              │
│    "access_token": "1|abc123...",                                 │
│    "user": {...}                                                  │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
```

### Модель Invitation

```php
class Invitation extends Model
{
    // Типы приглашений
    const TYPE_EMPLOYEE = 'employee';  // Для сотрудников
    const TYPE_CLIENT = 'client';      // Для клиентов (родственников)
    
    // Статусы
    const STATUS_PENDING = 'pending';    // Ожидает принятия
    const STATUS_ACCEPTED = 'accepted';  // Принято
    const STATUS_EXPIRED = 'expired';    // Истекло
    const STATUS_REVOKED = 'revoked';    // Отозвано
    
    // Доступные роли для сотрудников
    const ALLOWED_ROLES = ['admin', 'doctor', 'caregiver'];
    
    // Срок действия
    // Для сотрудников: 7 дней
    // Для клиентов: 30 дней
}
```

---

## Управление сотрудниками

### Просмотр списка сотрудников

```http
GET /api/v1/organization/employees
Authorization: Bearer {token}
```

**Query параметры:**
| Параметр | Тип | Описание |
|----------|-----|----------|
| `role` | string | Фильтр по роли: `owner`, `admin`, `doctor`, `caregiver` |

**Response:**
```json
[
    {
        "id": 1,
        "first_name": "Иван",
        "last_name": "Директоров",
        "middle_name": "Сергеевич",
        "phone": "79001234567",
        "role": "owner",
        "created_at": "2025-12-01T10:00:00.000000Z"
    },
    {
        "id": 2,
        "first_name": "Мария",
        "last_name": "Докторова",
        "middle_name": null,
        "phone": "79009876543",
        "role": "doctor",
        "created_at": "2025-12-15T14:30:00.000000Z"
    }
]
```

### Изменение роли сотрудника

```http
PATCH /api/v1/organization/employees/{id}/role
Authorization: Bearer {token}
```

**Request Body:**
```json
{
    "role": "admin"  // admin, doctor, caregiver
}
```

**Ограничения:**
- ⚠️ Только **Owner** может менять роли
- ❌ Нельзя изменить роль Owner
- ✅ Можно менять: `admin ↔ doctor ↔ caregiver`

**Response:**
```json
{
    "message": "Роль изменена",
    "employee": {
        "id": 2,
        "role": "admin"
    }
}
```

### Удаление сотрудника

```http
DELETE /api/v1/organization/employees/{id}
Authorization: Bearer {token}
```

**Ограничения:**
- Owner может удалить любого (кроме себя)
- Admin может удалить только Doctor и Caregiver
- ❌ Нельзя удалить Owner

**Response:**
```json
{
    "message": "Сотрудник удалён из организации"
}
```

### Что происходит при удалении:

```
┌─────────────────────────────────────────────────────────┐
│           DELETE /organization/employees/{id}           │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  1. user.organization_id = null                         │
│     (пользователь больше не привязан к организации)    │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  2. user.syncRoles([])                                  │
│     (все организационные роли удаляются)               │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  3. Аккаунт пользователя СОХРАНЯЕТСЯ                   │
│     • Он может войти в систему                         │
│     • Может быть приглашён в другую организацию        │
│     • Теряет доступ к данным организации               │
└─────────────────────────────────────────────────────────┘
```

---

## Назначение доступа к дневникам

### Различие между типами организаций

```
┌───────────────────────────────────┬───────────────────────────────────┐
│            ПАНСИОНАТ              │           АГЕНТСТВО               │
│        (boarding_house)           │            (agency)               │
├───────────────────────────────────┼───────────────────────────────────┤
│                                   │                                   │
│  ВСЕ сотрудники видят ВСЕХ       │  Сотрудник видит ТОЛЬКО           │
│  подопечных организации           │  назначенных ему подопечных       │
│                                   │                                   │
│  ✅ Не нужно назначать доступ     │  ⚠️ Нужно явно назначить доступ   │
│                                   │                                   │
│  Пример: дом престарелых,         │  Пример: агентство сиделок,       │
│  где все работают со всеми        │  где каждая сиделка закреплена    │
│                                   │  за конкретными клиентами        │
│                                   │                                   │
└───────────────────────────────────┴───────────────────────────────────┘
```

### Назначение доступа (для агентств)

```http
POST /api/v1/organization/assign-diary-access
Authorization: Bearer {token}
```

**Request Body:**
```json
{
    "patient_id": 1,
    "user_id": 5,
    "permission": "edit"  // view, edit, full (по умолчанию: edit)
}
```

**Уровни доступа:**
| Permission | Описание |
|------------|----------|
| `view` | Только просмотр дневника |
| `edit` | Просмотр + внесение записей |
| `full` | Полный доступ (включая настройки) |

**Response:**
```json
{
    "message": "Доступ к дневнику назначен",
    "patient_id": 1,
    "user_id": 5,
    "permission": "edit"
}
```

### Отзыв доступа

```http
DELETE /api/v1/organization/revoke-diary-access
Authorization: Bearer {token}
```

**Request Body:**
```json
{
    "patient_id": 1,
    "user_id": 5
}
```

**Response:**
```json
{
    "message": "Доступ к дневнику отозван"
}
```

---

## API Endpoints

### Организация

| Метод | Endpoint | Описание | Доступ |
|-------|----------|----------|--------|
| GET | `/api/v1/organization` | Информация об организации | Все сотрудники |
| PATCH | `/api/v1/organization` | Обновить организацию | Owner, Admin |
| GET | `/api/v1/organization/employees` | Список сотрудников | Все сотрудники |
| PATCH | `/api/v1/organization/employees/{id}/role` | Изменить роль | Owner |
| DELETE | `/api/v1/organization/employees/{id}` | Удалить сотрудника | Owner, Admin |
| POST | `/api/v1/organization/assign-diary-access` | Назначить доступ | Owner, Admin |
| DELETE | `/api/v1/organization/revoke-diary-access` | Отозвать доступ | Owner, Admin |

### Приглашения

| Метод | Endpoint | Описание | Доступ |
|-------|----------|----------|--------|
| GET | `/api/v1/invitations` | Список приглашений | Owner, Admin |
| POST | `/api/v1/invitations/employee` | Создать приглашение сотруднику | Owner, Admin |
| POST | `/api/v1/invitations/client` | Создать приглашение клиенту | Owner, Admin |
| GET | `/api/v1/invitations/{token}` | Информация о приглашении | Публичный |
| POST | `/api/v1/invitations/{token}/accept` | Принять приглашение | Публичный |
| DELETE | `/api/v1/invitations/{id}` | Отозвать приглашение | Owner, Admin |

---

## Примеры использования

### 1. Получить информацию об организации

```bash
curl https://api.healapp.kz/api/v1/organization \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Response:**
```json
{
    "id": 1,
    "name": "Пансионат 'Забота'",
    "type": "boarding_house",
    "phone": "79001234567",
    "address": "г. Алматы, ул. Примерная, 1",
    "description": "Современный пансионат для пожилых людей",
    "owner": {
        "id": 1,
        "first_name": "Иван",
        "last_name": "Директоров"
    },
    "employee_count": 5,
    "patient_count": 12
}
```

### 2. Пригласить врача

```bash
curl -X POST https://api.healapp.kz/api/v1/invitations/employee \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"role": "doctor"}'
```

**Response:**
```json
{
    "invitation": {
        "id": 15,
        "organization_id": 1,
        "inviter_id": 1,
        "token": "a1b2c3d4e5f6...",
        "type": "employee",
        "role": "doctor",
        "status": "pending",
        "expires_at": "2025-12-29T14:37:00.000000Z"
    },
    "invite_url": "https://app.healapp.kz/invite/a1b2c3d4e5f6..."
}
```

### 3. Просмотреть приглашение (для сотрудника)

```bash
curl https://api.healapp.kz/api/v1/invitations/a1b2c3d4e5f6...
```

**Response:**
```json
{
    "organization_name": "Пансионат 'Забота'",
    "organization_type": "boarding_house",
    "type": "employee",
    "role": "doctor",
    "expires_at": "2025-12-29T14:37:00.000000Z"
}
```

### 4. Принять приглашение (новый пользователь)

```bash
curl -X POST https://api.healapp.kz/api/v1/invitations/a1b2c3d4e5f6.../accept \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "79009876543",
    "password": "secret123",
    "password_confirmation": "secret123",
    "first_name": "Мария",
    "last_name": "Докторова"
  }'
```

**Response:**
```json
{
    "message": "Приглашение принято",
    "access_token": "2|xyz789...",
    "user": {
        "id": 10,
        "first_name": "Мария",
        "last_name": "Докторова",
        "phone": "79009876543",
        "type": "client",
        "organization": {
            "id": 1,
            "name": "Пансионат 'Забота'",
            "type": "boarding_house"
        }
    }
}
```

### 5. Получить список сотрудников с фильтром

```bash
# Все сотрудники
curl https://api.healapp.kz/api/v1/organization/employees \
  -H "Authorization: Bearer YOUR_TOKEN"

# Только врачи
curl "https://api.healapp.kz/api/v1/organization/employees?role=doctor" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Только сиделки
curl "https://api.healapp.kz/api/v1/organization/employees?role=caregiver" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 6. Назначить сиделку к подопечному (для агентства)

```bash
curl -X POST https://api.healapp.kz/api/v1/organization/assign-diary-access \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "patient_id": 3,
    "user_id": 7,
    "permission": "edit"
  }'
```

### 7. Изменить роль сотрудника

```bash
curl -X PATCH https://api.healapp.kz/api/v1/organization/employees/10/role \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"role": "admin"}'
```

### 8. Удалить сотрудника

```bash
curl -X DELETE https://api.healapp.kz/api/v1/organization/employees/10 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## Рабочие сценарии

### Сценарий 1: Создание команды для пансионата

```
1. Владелец регистрирует организацию (account_type: pansionat)
   └── Автоматически становится Owner
   
2. Создаёт приглашение для администратора
   POST /invitations/employee {"role": "admin"}
   
3. Создаёт приглашения для врачей
   POST /invitations/employee {"role": "doctor"} (x2)
   
4. Создаёт приглашения для сиделок
   POST /invitations/employee {"role": "caregiver"} (x5)
   
5. Отправляет ссылки сотрудникам

6. Сотрудники принимают приглашения
   └── Автоматически получают доступ ко ВСЕМ подопечным
```

### Сценарий 2: Назначение сиделки в агентстве

```
1. Admin создаёт приглашение для сиделки
   POST /invitations/employee {"role": "caregiver"}
   
2. Сиделка принимает приглашение
   └── Пока не видит никаких подопечных
   
3. Admin назначает доступ к конкретным подопечным
   POST /organization/assign-diary-access
   {
     "patient_id": 5,
     "user_id": 12,
     "permission": "edit"
   }
   
4. Сиделка теперь видит только назначенного подопечного
```

### Сценарий 3: Перевод врача в администраторы

```
1. Owner просматривает список сотрудников
   GET /organization/employees
   
2. Находит нужного врача (id: 15)

3. Меняет роль на admin
   PATCH /organization/employees/15/role {"role": "admin"}
   
4. Врач теперь имеет права администратора
```

### Сценарий 4: Увольнение сотрудника

```
1. Admin/Owner получает список сотрудников
   GET /organization/employees
   
2. Удаляет нужного сотрудника
   DELETE /organization/employees/20
   
3. Сотрудник:
   ├── Теряет привязку к организации
   ├── Теряет все роли
   ├── Теряет доступ к данным
   └── Сохраняет аккаунт (может быть приглашён в другую организацию)
```

---

## Коды ошибок

| Код | Описание |
|-----|----------|
| 401 | Неавторизован / Неверный пароль |
| 403 | Недостаточно прав (например, Doctor пытается управлять сотрудниками) |
| 404 | Сотрудник/приглашение/организация не найдены |
| 410 | Приглашение истекло или уже использовано |
| 422 | Ошибка валидации (неверная роль, попытка удалить Owner и т.д.) |

---

*Документация актуальна на 22.12.2024*
